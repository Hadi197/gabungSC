<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Outstanding</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .container {
            max-width: 95%;
        }
        .header {
            margin-bottom: 30px;
        }
        .table-responsive {
            margin-top: 20px;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        .dataTables_wrapper {
            width: 100%;
            overflow-x: auto;
        }
        table.dataTable {
            width: 100% !important;
            table-layout: auto;
        }
        table.dataTable td {
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 200px;
            overflow: hidden;
        }
        table.dataTable td.company-name {
            white-space: normal;
            min-width: 200px;
            max-width: 300px;
        }
        .topbar {
            width: 100%;
            background-color: #343a40;
            color: white;
            padding: 10px 20px;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        .topbar a {
            color: white;
            text-decoration: none;
            margin-right: 20px;
        }
        .topbar a:hover {
            text-decoration: underline;
        }
        .content {
            margin-top: 60px; /* Adjust based on topbar height */
            padding: 20px;
        }
        .card {
            text-align: center;
            background-color: #f8f9fa;
            border: 1px solid #007bff;
            width: 80%; /* Set card width to 80% */
            margin: 10px auto; /* Center the card and add margin */
        }
        .card-title {
            font-size: 0.8rem; /* Adjust font size */
            color: #007bff;
        }
        .card-text {
            font-size: 1rem; /* Adjust font size */
            color: #343a40;
        }
        .chart-container, .classification-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .clickable {
            cursor: pointer;
            color: #007bff;
            text-decoration: underline;
        }
        .classification-container h3 {
            font-size: 1rem; /* Adjust font size */
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <img src="https://via.placeholder.com/40" class="rounded-circle" alt="User Image">
                <span>PJMW3</span>
                <span class="ml-2">Outstanding</span>
            </div>
            <div>
                <a href="index.html"><i class="fas fa-home"></i> Dashboard</a>
                <a href="gabung.html"><i class="fas fa-table"></i> Data Table</a>
            </div>
        </div>
    </div>
    <div class="content">
        <div class="container">
            <div class="header">
                <h2>Data Outstanding</h2>
                <p>Last updated: <span id="lastUpdate"></span></p>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="companyNameChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="periodeSPBChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="container mt-4 classification-container">
                <h3>GT Classification</h3>
                <div class="row">
                    <div class="col-md-2">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">GT 0 - 500</h5>
                                <p class="card-text clickable" id="gt0to500">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">GT 501 - 3000</h5>
                                <p class="card-text clickable" id="gt501to3000">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">GT 3001 - 6000</h5>
                                <p class="card-text clickable" id="gt3001to6000">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">GT 6001 - 12000</h5>
                                <p class="card-text clickable" id="gt6001to12000">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">GT 12001 - 15000</h5>
                                <p class="card-text clickable" id="gt12001to15000">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">GT 15001 and above</h5>
                                <p class="card-text clickable" id="gt15001andAbove">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-responsive mt-4 classification-container">
                <h3>Vessel Classification</h3>
                <table id="dataTable" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>No. PKK Inaportnet</th>
                            <th>No. PKK</th>
                            <th>Arrive Date</th>
                            <th>Vessel Name</th>
                            <th>GT</th>
                            <th>LOA</th>
                            <th>Company Name</th>
                            <th>Process Status</th>
                            <th>Branch</th>
                            <th>No. SPB</th>
                            <th>Waktu SPB</th>
                            <th>Periode SPB</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script>
        $(document).ready(function() {
            // Load CSV data
            $.ajax({
                url: 'gabung.csv',
                dataType: 'text',
                success: function(data) {
                    const rows = data.split('\n');
                    const headers = rows[0].split(',');
                    
                    let tableData = [];
                    let totalVessels = 0;
                    let totalVesselsIDSUB = 0;
                    let totalVesselsIDGRE = 0;
                    let totalGT = 0;
                    let totalLOA = 0;
                    let gtClassification = {
                        gt0to500: 0,
                        gt501to3000: 0,
                        gt3001to6000: 0,
                        gt6001to12000: 0,
                        gt12001to15000: 0,
                        gt15001andAbove: 0
                    };
                    let companyNameCounts = {};
                    let periodeSPBCounts = {};

                    for(let i = 1; i < rows.length; i++) {
                        if(rows[i]) {
                            const row = rows[i];
                            const cells = [];
                            let inQuote = false;
                            let currentCell = '';
                            
                            for(let char of row) {
                                if(char === '"') {
                                    inQuote = !inQuote;
                                } else if(char === ',' && !inQuote) {
                                    cells.push(currentCell);
                                    currentCell = '';
                                } else {
                                    currentCell += char;
                                }
                            }
                            cells.push(currentCell);

                            tableData.push(['', ...cells]); // Add an empty cell for the checkbox

                            // Update totals and counts
                            totalVessels++;
                            const gt = parseFloat(cells[4]);
                            const loa = parseFloat(cells[5]);
                            totalGT += gt;
                            totalLOA += loa;

                            if (gt <= 500) {
                                gtClassification.gt0to500++;
                            } else if (gt <= 3000) {
                                gtClassification.gt501to3000++;
                            } else if (gt <= 6000) {
                                gtClassification.gt3001to6000++;
                            } else if (gt <= 12000) {
                                gtClassification.gt6001to12000++;
                            } else if (gt <= 15000) {
                                gtClassification.gt12001to15000++;
                            } else {
                                gtClassification.gt15001andAbove++;
                            }

                            const no_pkk_inaportnet = cells[0];
                            if (no_pkk_inaportnet.includes("IDSUB")) {
                                totalVesselsIDSUB++;
                            } else if (no_pkk_inaportnet.includes("IDGRE")) {
                                totalVesselsIDGRE++;
                            }

                            const companyName = cells[6];
                            const periodeSPB = cells[11].substring(0, 7); // Format as YYYY-MM

                            if (companyNameCounts[companyName]) {
                                companyNameCounts[companyName]++;
                            } else {
                                companyNameCounts[companyName] = 1;
                            }

                            if (periodeSPBCounts[periodeSPB]) {
                                periodeSPBCounts[periodeSPB]++;
                            } else {
                                periodeSPBCounts[periodeSPB] = 1;
                            }
                        }
                    }

                    // Update cards
                    $('#gt0to500').text(gtClassification.gt0to500);
                    $('#gt501to3000').text(gtClassification.gt501to3000);
                    $('#gt3001to6000').text(gtClassification.gt3001to6000);
                    $('#gt6001to12000').text(gtClassification.gt6001to12000);
                    $('#gt12001to15000').text(gtClassification.gt12001to15000);
                    $('#gt15001andAbove').text(gtClassification.gt15001andAbove);

                    // Initialize DataTable
                    const dataTable = $('#dataTable').DataTable({
                        data: tableData,
                        pageLength: 25,
                        order: [[3, 'desc']],
                        responsive: true,
                        autoWidth: true,
                        columns: [
                            { 
                                title: 'Select',
                                render: function() {
                                    return '<input type="checkbox" class="row-select">';
                                },
                                orderable: false
                            },
                            { title: headers[0] },
                            { title: headers[1] },
                            { title: headers[2] },
                            { title: headers[3] },
                            { title: headers[4] },
                            { title: headers[5] },
                            { 
                                title: headers[6],
                                className: 'company-name',
                                render: function(data) {
                                    return data.replace(/"/g, '');
                                }
                            },
                            { title: headers[7] },
                            { title: headers[8] },
                            { title: headers[9] },
                            { title: headers[10] },
                            { title: headers[11] }
                        ],
                        columnDefs: [
                            {
                                targets: '_all',
                                render: function(data) {
                                    return data ? data.toString().replace(/"/g, '') : '';
                                }
                            }
                        ]
                    });

                    // Update last updated time
                    const now = new Date();
                    $('#lastUpdate').text(now.toLocaleString());

                    function updateClassifications(filteredData) {
                        let totalVessels = 0;
                        let totalVesselsIDSUB = 0;
                        let totalVesselsIDGRE = 0;
                        let gtClassification = {
                            gt0to500: 0,
                            gt501to3000: 0,
                            gt3001to6000: 0,
                            gt6001to12000: 0,
                            gt12001to15000: 0,
                            gt15001andAbove: 0
                        };

                        filteredData.forEach(cells => {
                            totalVessels++;
                            const gt = parseFloat(cells[5]);

                            if (gt <= 500) {
                                gtClassification.gt0to500++;
                            } else if (gt <= 3000) {
                                gtClassification.gt501to3000++;
                            } else if (gt <= 6000) {
                                gtClassification.gt3001to6000++;
                            } else if (gt <= 12000) {
                                gtClassification.gt6001to12000++;
                            } else if (gt <= 15000) {
                                gtClassification.gt12001to15000++;
                            } else {
                                gtClassification.gt15001andAbove++;
                            }

                            const no_pkk_inaportnet = cells[1];
                            if (no_pkk_inaportnet.includes("IDSUB")) {
                                totalVesselsIDSUB++;
                            } else if (no_pkk_inaportnet.includes("IDGRE")) {
                                totalVesselsIDGRE++;
                            }
                        });

                        // Update cards
                        $('#gt0to500').text(gtClassification.gt0to500);
                        $('#gt501to3000').text(gtClassification.gt501to3000);
                        $('#gt3001to6000').text(gtClassification.gt3001to6000);
                        $('#gt6001to12000').text(gtClassification.gt6001to12000);
                        $('#gt12001to15000').text(gtClassification.gt12001to15000);
                        $('#gt15001andAbove').text(gtClassification.gt15001andAbove);

                        // Update table
                        const dataTable = $('#dataTable').DataTable();
                        dataTable.clear();
                        dataTable.rows.add(filteredData);
                        dataTable.draw();
                    }

                    function filterDataByCompanyName(companyName) {
                        return tableData.filter(cells => cells[7].replace(/"/g, '') === companyName);
                    }

                    function filterDataByPeriodeSPB(periodeSPB) {
                        return tableData.filter(cells => cells[12].substring(0, 7) === periodeSPB);
                    }

                    function filterDataByGTRange(minGT, maxGT) {
                        return tableData.filter(cells => {
                            const gt = parseFloat(cells[5]);
                            return gt >= minGT && gt <= maxGT;
                        });
                    }

                    function filterDataByTotalVessels() {
                        return tableData;
                    }

                    function filterDataByTotalVesselsIDSUB() {
                        return tableData.filter(cells => cells[1].includes("IDSUB"));
                    }

                    function filterDataByTotalVesselsIDGRE() {
                        return tableData.filter(cells => cells[1].includes("IDGRE"));
                    }

                    // Add click event listeners
                    $('#gt0to500').addClass('clickable').click(function() {
                        updateClassifications(filterDataByGTRange(0, 500));
                    });

                    $('#gt501to3000').addClass('clickable').click(function() {
                        updateClassifications(filterDataByGTRange(501, 3000));
                    });

                    $('#gt3001to6000').addClass('clickable').click(function() {
                        updateClassifications(filterDataByGTRange(3001, 6000));
                    });

                    $('#gt6001to12000').addClass('clickable').click(function() {
                        updateClassifications(filterDataByGTRange(6001, 12000));
                    });

                    $('#gt12001to15000').addClass('clickable').click(function() {
                        updateClassifications(filterDataByGTRange(12001, 15000));
                    });

                    $('#gt15001andAbove').addClass('clickable').click(function() {
                        updateClassifications(filterDataByGTRange(15001, Infinity));
                    });

                    // Handle row selection
                    $('#dataTable tbody').on('change', '.row-select', function() {
                        const row = $(this).closest('tr');
                        const vesselName = row.find('td:eq(4)').text();
                        const no_pkk_inaportnet = row.find('td:eq(1)').text();
                        if (this.checked) {
                            const confirmed = confirm(`Apakah ${vesselName} akan di hapus..?`);
                            if (confirmed) {
                                dataTable.row(row).remove().draw();
                            } else {
                                this.checked = false;
                            }
                        }
                    });

                    // Create charts
                    const companyNameChartCtx = document.getElementById('companyNameChart').getContext('2d');
                    const periodeSPBChartCtx = document.getElementById('periodeSPBChart').getContext('2d');

                    // Get top 10 companies
                    const topCompanies = Object.entries(companyNameCounts)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10);

                    const companyNameChart = new Chart(companyNameChartCtx, {
                        type: 'bar',
                        data: {
                            labels: topCompanies.map(entry => entry[0]),
                            datasets: [{
                                label: 'Company Name Count',
                                data: topCompanies.map(entry => entry[1]),
                                backgroundColor: topCompanies.map(entry => entry[1] >= 5 ? 'rgba(255, 0, 0, 0.2)' : 'rgba(54, 162, 235, 0.2)'),
                                borderColor: topCompanies.map(entry => entry[1] >= 5 ? 'rgba(255, 0, 0, 1)' : 'rgba(54, 162, 235, 1)'),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: true // Ensure legend is displayed
                                },
                                title: {
                                    display: true,
                                    text: 'Top 10 Company Name Distribution'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const companyName = topCompanies[context.dataIndex][0];
                                            const count = context.raw;
                                            return `${companyName}: ${count}`;
                                        }
                                    }
                                },
                                datalabels: {
                                    anchor: 'end',
                                    align: 'end',
                                    formatter: function(value) {
                                        return value;
                                    },
                                    color: 'black' // Set data label color
                                }
                            },
                            scales: {
                                x: {
                                    display: false // Hide x-axis labels
                                },
                                y: {
                                    beginAtZero: true
                                }
                            },
                            onClick: function(event, elements) {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const companyName = topCompanies[index][0];
                                    const filteredData = filterDataByCompanyName(companyName);
                                    updateClassifications(filteredData);
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });

                    const sortedPeriodeSPBCounts = Object.entries(periodeSPBCounts).sort((a, b) => new Date(a[0]) - new Date(b[0]));

                    const periodeSPBChart = new Chart(periodeSPBChartCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedPeriodeSPBCounts.map(entry => entry[0]),
                            datasets: [{
                                label: 'Periode SPB Count',
                                data: sortedPeriodeSPBCounts.map(entry => entry[1]),
                                backgroundColor: sortedPeriodeSPBCounts.map(entry => entry[1] >= 5 ? 'rgba(255, 0, 0, 0.2)' : 'rgba(54, 162, 235, 0.2)'),
                                borderColor: sortedPeriodeSPBCounts.map(entry => entry[1] >= 5 ? 'rgba(255, 0, 0, 1)' : 'rgba(54, 162, 235, 1)'),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: true // Ensure legend is displayed
                                },
                                title: {
                                    display: true,
                                    text: 'Periode SPB Distribution'
                                },
                                datalabels: {
                                    anchor: 'end',
                                    align: 'end',
                                    formatter: function(value) {
                                        return value;
                                    },
                                    color: 'black' // Set data label color
                                }
                            },
                            scales: {
                                x: {
                                    display: true
                                },
                                y: {
                                    beginAtZero: true
                                }
                            },
                            onClick: function(event, elements) {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const periodeSPB = sortedPeriodeSPBCounts[index][0];
                                    const filteredData = filterDataByPeriodeSPB(periodeSPB);
                                    updateClassifications(filteredData);
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load CSV data:', {
                        status: status,
                        statusText: xhr.statusText,
                        responseText: xhr.responseText,
                        error: error
                    });
                    alert('Failed to load CSV data. Check console for details.');
                }
            });
        });
    </script>
</body>
</html>
