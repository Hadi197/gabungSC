<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Data Kapal Gabungan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.css">
    <style>
        body {
            padding: 20px;
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .container {
            max-width: 95%;
        }
        .header {
            margin-bottom: 30px;
        }
        .table-responsive {
            margin-top: 20px;
        }
        th {
            background-color: #f8f9fa;
        }
        .dataTables_wrapper {
            width: 100%;
            overflow-x: auto;
        }
        table.dataTable {
            width: 100% !important;
            table-layout: auto;
        }
        table.dataTable td {
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 200px;
            overflow: hidden;
        }
        table.dataTable td.company-name {
            white-space: normal;
            min-width: 200px;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Dashboard Data Kapal Gabungan</h2>
            <p>Last updated: <span id="lastUpdate"></span></p>
            <button id="runScriptButton" class="btn btn-primary">Run gabung.py</button>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Total Vessels</h5>
                        <p class="card-text" id="totalVessels">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Total GT</h5>
                        <p class="card-text" id="totalGT">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Total LOA</h5>
                        <p class="card-text" id="totalLOA">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <canvas id="vesselTypeChart"></canvas>
            </div>
            <div class="col-md-6">
                <canvas id="branchChart"></canvas>
            </div>
        </div>

        <div class="table-responsive mt-4">
            <table id="dataTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>No. PKK Inaportnet</th>
                        <th>No. PKK</th>
                        <th>Arrive Date</th>
                        <th>Vessel Name</th>
                        <th>GT</th>
                        <th>LOA</th>
                        <th>Company Name</th>
                        <th>Process Status</th>
                        <th>Branch</th>
                        <th>No. SPB</th>
                        <th>Waktu SPB</th>
                        <th>Periode SPB</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        $(document).ready(function() {
            // Load CSV data
            function loadCSVData() {
                $.ajax({
                    url: 'gabung.csv',
                    dataType: 'text',
                    success: function(data) {
                        const rows = data.split('\n');
                        const headers = rows[0].split(',');
                        
                        let tableData = [];
                        let totalVessels = 0;
                        let totalGT = 0;
                        let totalLOA = 0;
                        let vesselTypeCounts = {};
                        let branchCounts = {};

                        for(let i = 1; i < rows.length; i++) {
                            if(rows[i]) {
                                const row = rows[i];
                                const cells = [];
                                let inQuote = false;
                                let currentCell = '';
                                
                                for(let char of row) {
                                    if(char === '"') {
                                        inQuote = !inQuote;
                                    } else if(char === ',' && !inQuote) {
                                        cells.push(currentCell);
                                        currentCell = '';
                                    } else {
                                        currentCell += char;
                                    }
                                }
                                cells.push(currentCell);
                                tableData.push(cells);

                                // Update totals and counts
                                totalVessels++;
                                totalGT += parseFloat(cells[4]);
                                totalLOA += parseFloat(cells[5]);

                                const vesselType = cells[7];
                                const branch = cells[8];

                                if (vesselTypeCounts[vesselType]) {
                                    vesselTypeCounts[vesselType]++;
                                } else {
                                    vesselTypeCounts[vesselType] = 1;
                                }

                                if (branchCounts[branch]) {
                                    branchCounts[branch]++;
                                } else {
                                    branchCounts[branch] = 1;
                                }
                            }
                        }

                        // Update cards
                        $('#totalVessels').text(totalVessels);
                        $('#totalGT').text(totalGT.toFixed(2));
                        $('#totalLOA').text(totalLOA.toFixed(2));

                        // Initialize DataTable
                        $('#dataTable').DataTable({
                            data: tableData,
                            pageLength: 25,
                            order: [[2, 'desc']],
                            responsive: true,
                            autoWidth: true,
                            columns: [
                                { title: headers[0] },
                                { title: headers[1] },
                                { title: headers[2] },
                                { title: headers[3] },
                                { title: headers[4] },
                                { title: headers[5] },
                                { 
                                    title: headers[6],
                                    className: 'company-name',
                                    render: function(data) {
                                        return data.replace(/"/g, '');
                                    }
                                },
                                { title: headers[7] },
                                { title: headers[8] },
                                { title: headers[9] },
                                { title: headers[10] },
                                { title: headers[11] }
                            ],
                            columnDefs: [
                                {
                                    targets: '_all',
                                    render: function(data) {
                                        return data ? data.toString().replace(/"/g, '') : '';
                                    }
                                }
                            ]
                        });

                        // Update last updated time
                        const now = new Date();
                        $('#lastUpdate').text(now.toLocaleString());

                        // Create charts
                        const vesselTypeChartCtx = document.getElementById('vesselTypeChart').getContext('2d');
                        const branchChartCtx = document.getElementById('branchChart').getContext('2d');

                        new Chart(vesselTypeChartCtx, {
                            type: 'pie',
                            data: {
                                labels: Object.keys(vesselTypeCounts),
                                datasets: [{
                                    data: Object.values(vesselTypeCounts),
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.2)',
                                        'rgba(54, 162, 235, 0.2)',
                                        'rgba(255, 206, 86, 0.2)',
                                        'rgba(75, 192, 192, 0.2)',
                                        'rgba(153, 102, 255, 0.2)',
                                        'rgba(255, 159, 64, 0.2)'
                                    ],
                                    borderColor: [
                                        'rgba(255, 99, 132, 1)',
                                        'rgba(54, 162, 235, 1)',
                                        'rgba(255, 206, 86, 1)',
                                        'rgba(75, 192, 192, 1)',
                                        'rgba(153, 102, 255, 1)',
                                        'rgba(255, 159, 64, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'Vessel Type Distribution'
                                    }
                                }
                            }
                        });

                        new Chart(branchChartCtx, {
                            type: 'bar',
                            data: {
                                labels: Object.keys(branchCounts),
                                datasets: [{
                                    label: 'Branch Count',
                                    data: Object.values(branchCounts),
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Branch Distribution'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load CSV data:', {
                            status: status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        alert('Failed to load CSV data. Check console for details.');
                    }
                });
            }

            // Initial load of CSV data
            loadCSVData();

            // Handle run script button click
            $('#runScriptButton').on('click', function() {
                $.ajax({
                    url: 'run_gabung.php',
                    method: 'GET',
                    success: function(response) {
                        console.log('Script execution response:', response);
                        if (response.success) {
                            alert('Script executed successfully');
                            // Reload CSV data after script execution
                            loadCSVData();
                        } else {
                            alert('Failed to execute script: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error executing script:', {
                            status: status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        alert('Error executing script. Check console for details.');
                    }
                });
            });
        });
    </script>
</body>
</html>
